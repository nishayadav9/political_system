{% extends 'core/admin/base.html' %}

{% block content %}
<style>
  .table-container {
    width: 100%;
    max-height: 600px;
    overflow-x: auto;
    overflow-y: auto;
    margin-top: 1rem;
    border-radius: 12px;
    background: #fff;
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 1400px;
  }

  thead th {
    background: linear-gradient(90deg, #0d9488, #14b8a6);
    color: #fff;
    font-weight: 600;
    padding: 0.75rem;
    text-align: center;
    font-size: 0.9rem;
  }

  thead tr.section-header th {
    background: #0f766e;
    font-size: 1rem;
    text-transform: uppercase;
    text-align: center;
  }

  tbody td {
    padding: 0.7rem;
    border-bottom: 1px solid #e5e7eb;
    text-align: center;
    font-size: 0.88rem;
    color: #374151;
  }

  tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }

  tbody tr:hover {
    background-color: #e0f2fe;
    transition: 0.2s ease-in-out;
  }

  .btn {
    padding: 0.35rem 0.75rem;
    font-size: 0.8rem;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
  }

  .btn-primary { background-color: #3b82f6; color: #fff; border: none; }
  .btn-primary:hover { background-color: #2563eb; }

  .btn-danger { background-color: #ef4444; color: #fff; border: none; }
  .btn-danger:hover { background-color: #dc2626; }

  .btn-success { background-color: #10b981; color: #fff; border: none; }
  .btn-success:hover { background-color: #059669; }

  h2 {
    font-weight: 700;
    color: #111827;
    margin-bottom: 1rem;
    font-size: 1.3rem;
    border-left: 5px solid #6366f1;
    padding-left: 0.5rem;
  }

  input[type="checkbox"] {
    transform: scale(1.15);
    cursor: pointer;
    accent-color: #16a34a;
  }
</style>

<h2>ðŸ“‹ Manage District Level Party Members</h2>

<form method="get" class="row g-2 mb-3 align-items-center">
  <!-- USERNAME SEARCH -->
  <div class="col-12 col-sm-6 col-md-2">
    <input type="text" name="username" 
           class="form-control form-control-sm" 
           placeholder="Username" 
           value="{{ username }}">
  </div>

  <!-- STATE DROPDOWN -->
  <div class="col-12 col-sm-6 col-md-2">
    <select name="state" id="stateDropdown" class="form-select form-select-sm">
      <option value="">State</option>
      {% for st in states %}
        <option value="{{ st }}" {% if st == state %}selected{% endif %}>{{ st }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- DISTRICT DROPDOWN -->
  <div class="col-12 col-sm-6 col-md-2">
    <select name="district" id="districtDropdown" class="form-select form-select-sm">
      <option value="">District</option>
      {% for dist in districts %}
        <option value="{{ dist }}" {% if dist == district %}selected{% endif %}>{{ dist }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- BUTTONS -->
  <div class="col-12 col-sm-6 col-md-2 d-flex gap-1">
    <button type="submit" class="btn btn-primary btn-sm w-100">Search</button>
    <a href="{% url 'manage_district_member' %}" class="btn btn-secondary btn-sm w-100">Reset</a>
  </div>
</form>



<a href="{% url 'add_district_member' %}" class="btn btn-success mb-3">âž• Add New Member</a>

<div class="table-container">
  <table>
    <thead>
      <tr class="section-header">
        <th colspan="16">Personal Details</th>
        <th colspan="8">Official Details</th>
      </tr>
      <tr>
                <th>S. No.</th>  <!-- âœ… Serial number first column -->

        <th>Username</th>
        <th>Password</th>
        <th>Full Name</th>
        <th>Father/Mother Name</th>
        <th>DOB</th>
        <th>Gender</th>
        <th>Mobile</th>
        <th>Alt. Mobile</th>
        <th>Email</th>
        <th>Aadhar/Govt ID</th>
        <th>Permanent Address</th>
        <th>Current Address</th>
        <th>State</th>
        <th>District</th>
        <th>Block/Tehsil</th>
        <th>Village/Town/City</th>
        <th>Pincode</th>
        <th>Role</th>
        <th>Assigned District(s)</th>
        <th>Local Knowledge</th>
        <th>Experience</th>
        <th>Date Added</th>
        <th>Active</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for member in members %}
      <tr>
              <td>{{ forloop.counter }}</td>  <!-- âœ… Auto S.No. -->

        <td>{{ member.username }}</td>
        <td>{{ member.plain_password|default:"-" }}</td>
        <td>{{ member.full_name|default:"-" }}</td>
        <td>{{ member.father_or_mother_name|default:"-" }}</td>
        <td>{{ member.date_of_birth|date:"d M Y"|default:"-" }}</td>
        <td>{{ member.gender|default:"-" }}</td>
        <td>{{ member.mobile_number|default:"-" }}</td>
        <td>{{ member.alternate_mobile_number|default:"-" }}</td>
        <td>{{ member.email|default:"-" }}</td>
        <td>
          {% if member.aadhar_or_govt_id %}
            {{ member.aadhar_or_govt_id|slice:":4" }}****{{ member.aadhar_or_govt_id|slice:"-4:" }}
          {% else %}-{% endif %}
        </td>
        <td title="{{ member.permanent_address }}">{{ member.permanent_address|truncatechars:20|default:"-" }}</td>
        <td title="{{ member.current_address }}">{{ member.current_address|truncatechars:20|default:"-" }}</td>
        <td>{{ member.state|default:"-" }}</td>
        <td>{{ member.district|default:"-" }}</td>
        <td>{{ member.block_tehsil_taluka|default:"-" }}</td>
        <td>{{ member.village_town_city|default:"-" }}</td>
        <td>{{ member.pincode|default:"-" }}</td>

        <td>{% if member.role %}{{ member.role.role_name }}{% else %}-{% endif %}</td>
        <td title="{{ member.assigned_district }}">{{ member.assigned_district|truncatechars:20|default:"-" }}</td>
        <td>{{ member.local_area_knowledge|default:"-" }}</td>
        <td>{{ member.political_experience_years|default:"-" }}</td>
        <td>{{ member.created_at|date:"d M Y, H:i" }}</td>
        <td>
          <input type="checkbox" class="toggle-active"
                 data-id="{{ member.id }}"
                 {% if member.is_active %}checked{% endif %}>
        </td>

        <td>
          <a href="{% url 'edit_district_member' member.id %}" class="btn btn-sm btn-primary">Edit</a>
          <form method="POST" action="{% url 'delete_district_member' member.id %}" style="display:inline;" onsubmit="return confirm('Delete {{ member.full_name|default:member.username }}?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="24" class="text-center">No district level members found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- CSRF Token hidden input -->
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<script>
  // ---------------- CSRF Token ----------------
  const csrfToken = document.getElementById('csrf-token').value;

  // ---------------- Toggle Active (AJAX) ----------------
  document.querySelectorAll('.toggle-active').forEach(checkbox => {
    checkbox.addEventListener('change', function () {
      const memberId = this.dataset.id;
      const isActive = this.checked;

      fetch(`/toggle-active/${memberId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ active: isActive }),
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          alert('Failed: ' + (data.error || 'Unknown error'));
          this.checked = !isActive;
        }
      })
      .catch(err => {
        alert('Error: ' + err.message);
        this.checked = !isActive;
      });
    });
  });

  // ---------------- State â†’ District Dynamic Dropdown ----------------
  const stateDistrictMap = JSON.parse('{{ states_and_districts|escapejs }}');
  const stateDropdown = document.getElementById('stateDropdown');
  const districtDropdown = document.getElementById('districtDropdown');

  function populateDistricts(state, selectedDistrict = "") {
    districtDropdown.innerHTML = '<option value="">All Districts</option>';
    if (state && stateDistrictMap[state]) {
      stateDistrictMap[state].forEach(dist => {
        const option = document.createElement('option');
        option.value = dist;
        option.textContent = dist;
        if (dist === selectedDistrict) option.selected = true;
        districtDropdown.appendChild(option);
      });
    }
  }

  // Populate on page load if state already selected
  populateDistricts(stateDropdown.value, "{{ district }}");

  stateDropdown.addEventListener('change', function () {
    populateDistricts(this.value);
  });
</script>


{% endblock %}
