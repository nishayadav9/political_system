{% extends 'core/admin/base.html' %}

{% block content %}
<h2>Manage Core Members</h2>

<!-- CSRF token for JS use -->
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<a href="{% url 'add_core_member' %}" class="btn btn-success mb-3">Add Core Member</a>

<table class="table table-bordered table-striped align-middle">
  <thead>
    <tr>
      <th>Username</th>
      <th>Full Name</th>
      <th>Email</th>
      <th>Mobile Number</th>
      <th>Role</th>
      <th>Location Level</th>
      <th>Address</th>
      <th>Access Start Time</th>
      <th>Access End Time</th>
      <th>Password</th>
      <th>Active</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for member in members %}
      <tr>
        <td>{{ member.username }}</td>
        <td>{{ member.full_name }}</td>
        <td>{{ member.email|default:"—" }}</td>
        <td>{{ member.mobile_number|default:"—" }}</td>
        <td>{{ member.role.role_name|default:"—" }}</td>
        <td>
          {% if member.location.block_name != "NA" %}
            Block
          {% elif member.location.district_name != "NA" %}
            District
          {% elif member.location.state_name != "NA" %}
            State
          {% else %}
            —
          {% endif %}
        </td>
        <td>{{ member.address|default:"—" }}</td>
        <td>{{ member.access_start_time|date:"Y-m-d H:i" }}</td>
        <td>{{ member.access_end_time|date:"Y-m-d H:i" }}</td>
        <td>
          {% if member.raw_password %}
            {{ member.raw_password }}
          {% else %}
            <span class="text-muted">Hidden</span>
          {% endif %}
        </td>
        <td class="text-center">
  <input type="checkbox"
         class="form-check-input toggle-active"
         data-model="core"
         data-id="{{ member.id }}"
         {% if member.is_active %}checked{% endif %}>
</td>

        <td>
          <a href="{% url 'edit_core_member' member.id %}" class="btn btn-sm btn-primary">Edit</a>
          <form method="POST" action="{% url 'delete_core_member' member.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger"
                    onclick="return confirm('Are you sure you want to delete this member?');">Delete</button>
          </form>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="12" class="text-center">No core members found.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- JS for toggling Active status -->
<script>
  const csrfToken = document.getElementById('csrf-token').value;

  document.querySelectorAll('.toggle-active').forEach(checkbox => {
    checkbox.addEventListener('change', function () {
      const modelName = this.dataset.model;
      const memberId = this.dataset.id;
      const isActive = this.checked;

      fetch(`/toggle-active/${modelName}/${memberId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ active: isActive })
      })
      .then(response => {
        if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (!data.success) {
          alert('Update failed: ' + (data.error || 'Unknown error.'));
          this.checked = !isActive;
        }
      })
      .catch(err => {
        alert('Error updating status: ' + err.message);
        this.checked = !isActive;
      });
    });
  });
</script>

{% endblock %}
