{% extends 'core/district_admin/base.html' %}

{% block content %}

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}

<div class="container mt-5">
  <h2 class="mb-4 text-primary fw-bold">District Complaints</h2>


   <!-- Filter Form -->
<form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
        <label class="form-label">Block</label>
        <input type="text" 
               name="block" 
               class="form-control" 
               placeholder="Enter Block name"
               value="{{ request.GET.block }}">
    </div>

    <div class="col-md-4">
        <label class="form-label">Panchayat</label>
        <input type="text" 
               name="panchayat" 
               class="form-control" 
               placeholder="Enter Panchayat name"
               value="{{ request.GET.panchayat }}">
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <!-- âœ… Reset button -->
        <a href="{% url 'district_admin_complaints' %}" class="btn btn-secondary w-100">Reset</a>
    </div>
</form>




  <div class="table-responsive shadow rounded">
    <table class="table table-bordered table-hover align-middle text-nowrap">
      <thead class="table-dark text-center">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Mobile</th>
          <th>Issue Type</th>
          <th>Title</th>
          <th>Description</th>
          <th>Address</th>
          <th>State</th>
          <th>District</th>
          <th>Block</th>
          <th>Pincode</th>
          <th>Status</th>
          <th>Photo</th>
          <th>Upload Photo</th>
          <th>Upload Video</th>
          <th>Files</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for complaint in complaints %}
          {% if complaint.state == request.user.assigned_state and complaint.district == request.user.assigned_district %}
            <tr>
              <td class="text-center">{{ forloop.counter }}</td>
              <td>{{ complaint.name|default_if_none:"-" }}</td>
              <td>{{ complaint.mobile|default_if_none:"-" }}</td>
              <td class="text-capitalize">{{ complaint.issue_type }}</td>
              <td>{{ complaint.title }}</td>
              <td style="max-width: 200px; white-space: pre-wrap;">{{ complaint.description|truncatechars:80 }}</td>
              <td>{{ complaint.address|default_if_none:"-" }}</td>
              <td>{{ complaint.state|default_if_none:"-" }}</td>
              <td>{{ complaint.district|default_if_none:"-" }}</td>
              <td>{{ complaint.block|default_if_none:"-" }}</td>
              <td>{{ complaint.pincode|default_if_none:"-" }}</td>

              <td class="text-center">
  {% if complaint.status == "Solved" %}
    <span class="badge bg-info text-dark">Solved</span>
  {% elif complaint.status == "Accepted" %}
    <span class="badge bg-success">Accepted</span>
  {% elif complaint.status == "Rejected" %}
    <span class="badge bg-warning text-dark">Rejected</span>
  {% else %}
    <span class="badge bg-secondary">Pending</span>
  {% endif %}
</td>

              <!-- Media -->
              <td class="text-center">
                {% if complaint.photo %}
                  <a href="{{ complaint.photo.url }}" target="_blank">
                    <img src="{{ complaint.photo.url }}" alt="Photo" style="max-width: 50px; max-height: 40px; object-fit: cover; border-radius: 4px;">
                  </a>
                {% else %}
                  <span class="text-muted small">No</span>
                {% endif %}
              </td>

              <td class="text-center">
                {% if complaint.upload_photo %}
                  <a href="{{ complaint.upload_photo.url }}" target="_blank">View</a>
                {% else %}
                  <span class="text-muted">No</span>
                {% endif %}
              </td>

              <td class="text-center">
                {% if complaint.upload_video %}
                  <a href="{{ complaint.upload_video.url }}" target="_blank" class="text-primary fs-5">
                    <i class="bi bi-camera-video"></i>
                  </a>
                {% else %}
                  <span class="text-muted small">No</span>
                {% endif %}
              </td>

              <!-- Files -->
              <td>
                {% if complaint.files.all %}
                  {% for file in complaint.files.all %}
                    <a href="{{ file.file_path.url }}" target="_blank" class="badge bg-primary text-white text-decoration-none mb-1">File</a>
                  {% endfor %}
                {% else %}
                  <span class="text-muted small">No</span>
                {% endif %}
              </td>

              <td>{{ complaint.created_at|date:"d M Y, H:i" }}</td>

              <!-- Actions -->
              <td>
                <div class="d-flex flex-column gap-1">

                  
                  <!-- Delete -->
                  <form action="{% url 'district_complaints_delete' complaint.id %}" method="POST" onsubmit="return confirm('Are you sure you want to delete this complaint?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                  </form>

                  <!-- Accept -->
                  {% if complaint.status != 'Accepted' %}
                  <form action="{% url 'district_complaints_accept' complaint.id %}" method="POST" onsubmit="return confirm('Accept this complaint?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success">Accept</button>
                  </form>
                  {% endif %}

                  <!-- Reject -->
                  {% if complaint.status != 'Rejected' %}
                  <form action="{% url 'district_complaints_reject' complaint.id %}" method="POST" onsubmit="return confirm('Reject this complaint?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-warning text-dark">Reject</button>
                  </form>
                  {% endif %}

                  <!-- Resolve -->
                  {% if complaint.status == 'Accepted' and not complaint.resolved_at %}
                  <form action="{% url 'district_complaints_resolve' complaint.id %}" method="POST" onsubmit="return confirm('Mark this complaint as resolved?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-info text-white">Resolve</button>
                  </form>
                  {% endif %}

                  <!-- Forward to State -->
                  {% if complaint.status == 'Accepted' %}
                    {% if complaint.send_to != 'state' %}
                      <form action="{% url 'district_complaints_forward' complaint.id %}" method="POST" onsubmit="return confirm('Forward this complaint to State Admin?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-secondary mb-1 w-100">Forward</button>
                      </form>
                    {% else %}
                      <span class="badge bg-dark w-100 d-inline-block">Forwarded</span>
                    {% endif %}
                  {% endif %}

                </div>
              </td>

            </tr>
          {% endif %}
        {% empty %}
          <tr>
            <td colspan="19" class="text-center text-muted fst-italic py-4">No complaints found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
